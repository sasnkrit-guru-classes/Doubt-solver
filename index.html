<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE/Boards Focus Workspace</title>
    
    <!-- Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
    
    <!-- Markdown & MathJax -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-body: #0d1117;       /* GitHub Dim */
            --bg-sidebar: #010409;    /* Darker */
            --bg-chat: #0d1117;
            --border: #30363d;
            --accent: #2f81f7;        /* Blue */
            --text-main: #e6edf3;
            --text-dim: #8b949e;
            --user-bubble: #1f6feb;
            --ai-bubble: #161b22;
            --success: #238636;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, sans-serif; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 280px;
            min-width: 280px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 50;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .btn-new-chat {
            width: 100%;
            padding: 10px;
            background: var(--success);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn-new-chat:hover { opacity: 0.9; }

        #folders-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        /* Folders */
        .folder-group { margin-bottom: 5px; }
        
        .folder-header {
            padding: 8px 15px;
            color: var(--text-dim);
            font-size: 0.85rem;
            font-weight: bold;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .folder-header:hover { color: var(--text-main); }
        .folder-header i { transition: transform 0.2s; }
        .folder-header.collapsed i { transform: rotate(-90deg); }

        .chat-list { display: block; }
        .chat-list.hidden { display: none; }

        /* Chat Items */
        .chat-item {
            padding: 8px 15px 8px 25px;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid transparent;
            position: relative;
        }
        
        .chat-item:hover { background-color: #21262d; }
        .chat-item.active { background-color: #21262d; border-left-color: var(--accent); }
        
        .chat-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 180px;
        }

        .chat-options-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            opacity: 0;
            cursor: pointer;
            padding: 2px 6px;
        }
        .chat-item:hover .chat-options-btn { opacity: 1; }

        /* Sidebar Footer (Add Folder) */
        .sidebar-footer {
            padding: 10px;
            border-top: 1px solid var(--border);
        }
        .btn-small {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 5px 10px;
            border-radius: 4px;
            width: 100%;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-small:hover { border-color: var(--text-main); color: var(--text-main); }

        /* --- MAIN AREA --- */
        #main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        header {
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            background: var(--bg-body);
        }
        header h2 { font-size: 1.2rem; font-weight: 500; }
        header .badge { background: #1f6feb; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 10px; vertical-align: middle; }

        /* Chat Container */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 1rem;
            position: relative;
        }

        .user-msg { display: flex; justify-content: flex-end; }
        .user-msg .message-content {
            background-color: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .ai-msg { display: flex; justify-content: flex-start; }
        .ai-msg .message-content {
            background-color: var(--ai-bubble);
            border: 1px solid var(--border);
            border-bottom-left-radius: 2px;
            color: var(--text-main);
        }

        /* LaTeX/Code overrides */
        mjx-container { font-size: 110% !important; color: var(--text-main); }
        pre { background: #000 !important; padding: 10px; border-radius: 6px; overflow-x: auto; border: 1px solid #333; }
        code { font-family: Consolas, monospace; color: #ff7b72; }

        /* --- INPUT AREA --- */
        #input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-body);
        }
        
        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            background: var(--ai-bubble);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
        }

        #file-preview { display: flex; gap: 10px; margin-bottom: 5px; flex-wrap: wrap; }
        .file-tag { background: #333; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; }

        .input-controls { display: flex; align-items: flex-end; gap: 10px; }
        
        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            resize: none;
            height: 24px;
            max-height: 150px;
            outline: none;
            font-size: 1rem;
            padding: 4px 0;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 5px;
            font-size: 1.1rem;
            transition: 0.2s;
        }
        .action-btn:hover { color: var(--accent); }
        .send-btn { color: var(--accent); }

        input[type="file"] { display: none; }

        /* Context Menu (Move/Delete) */
        #context-menu {
            position: absolute;
            background: #1c2128;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .ctx-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-main);
            display: block;
            width: 100%;
            text-align: left;
            background: none;
            border: none;
        }
        .ctx-item:hover { background: var(--accent); color: white; border-radius: 4px; }
        .ctx-divider { border-bottom: 1px solid var(--border); margin: 4px 0; }

    </style>
</head>
<body>

<!-- SIDEBAR -->
<aside id="sidebar">
    <div class="sidebar-header">
        <button class="btn-new-chat" onclick="createNewChat()">
            <i class="fas fa-plus"></i> New Doubt
        </button>
    </div>
    
    <div id="folders-list">
        <!-- Folders injected via JS -->
    </div>

    <div class="sidebar-footer">
        <button class="btn-small" onclick="createCustomFolder()">
            <i class="fas fa-folder-plus"></i> New Folder
        </button>
    </div>
</aside>

<!-- MAIN CONTENT -->
<div id="main-area">
    <header>
        <h2>Focus Mode</h2>
        <span class="badge">Gemini 3 Pro</span>
    </header>

    <div id="chat-container">
        <!-- Messages -->
        <div class="message ai-msg">
            <div class="message-content">
                Welcome to your <strong>Structured Study Space</strong>.<br>
                I will solve your doubts using <strong>LaTeX</strong>.<br>
                Your chats are auto-organized into folders (Maths, Physics, etc.).<br><br>
                <em>Attachments are processed but only text history is saved to keep things fast.</em>
            </div>
        </div>
    </div>

    <div id="input-area">
        <div class="input-wrapper">
            <div id="file-preview"></div>
            <div class="input-controls">
                <button class="action-btn" onclick="document.getElementById('file-input').click()" title="Attach">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="file-input" multiple accept="image/*,.pdf">
                
                <textarea id="user-input" placeholder="Type a doubt..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                
                <button class="action-btn send-btn" id="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="context-menu">
    <button class="ctx-item" onclick="triggerRename()">Rename</button>
    <div class="ctx-divider"></div>
    <div id="move-options"></div>
    <div class="ctx-divider"></div>
    <button class="ctx-item" onclick="triggerDelete()" style="color:#ff6b6b">Delete</button>
</div>

<script>
    // --- CONFIG & CONSTANTS ---
    const MODEL = 'gemini-3-pro-preview';
    const DB_KEY = 'jee_tutor_db_v2';

    // System Prompt
    const SYSTEM_PROMPT = `ROLE: JEE Advanced & CBSE Class 12 Tutor.
    SUBJECTS: Physics, Chemistry, Maths, English, Physical Education.
    RULES:
    1. REJECT non-study topics firmly.
    2. MATH: Use LaTeX strictly. Inline: $...$, Block: $$...$$
    3. TONE: Serious, academic, minimal emoji.
    4. If image provided: Solve the question visible in it.`;

    // --- STATE MANAGEMENT ---
    // Structure: { folders: ['Maths', 'Physics', ...], chats: { 'id1': { title, folder, messages: [] } } }
    let appState = {
        folders: ['Maths', 'Physics', 'Chemistry', 'English', 'General'],
        chats: {}
    };

    let currentChatId = null;
    let currentAttachments = [];
    let activeContextMenuChatId = null;

    // Load from LocalStorage
    function loadState() {
        const stored = localStorage.getItem(DB_KEY);
        if (stored) {
            try {
                appState = JSON.parse(stored);
                // Ensure default folders exist
                ['Maths', 'Physics', 'Chemistry', 'General'].forEach(f => {
                    if (!appState.folders.includes(f)) appState.folders.push(f);
                });
            } catch (e) { console.error("DB Error", e); }
        }
    }

    function saveState() {
        localStorage.setItem(DB_KEY, JSON.stringify(appState));
        renderSidebar();
    }

    // --- SIDEBAR & FOLDERS ---
    function renderSidebar() {
        const container = document.getElementById('folders-list');
        container.innerHTML = '';

        appState.folders.forEach(folder => {
            // Filter chats in this folder
            const chatsInFolder = Object.values(appState.chats)
                .filter(c => c.folder === folder)
                .sort((a,b) => b.timestamp - a.timestamp);

            const folderDiv = document.createElement('div');
            folderDiv.className = 'folder-group';
            
            // Header
            const header = document.createElement('div');
            header.className = 'folder-header';
            header.innerHTML = `<span>${folder} (${chatsInFolder.length})</span> <i class="fas fa-chevron-down"></i>`;
            header.onclick = () => {
                const list = folderDiv.querySelector('.chat-list');
                list.classList.toggle('hidden');
                header.classList.toggle('collapsed');
            };

            // List
            const list = document.createElement('div');
            list.className = 'chat-list';
            
            chatsInFolder.forEach(chat => {
                const item = document.createElement('div');
                item.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
                item.innerHTML = `
                    <span class="chat-title">${chat.title}</span>
                    <button class="chat-options-btn" onclick="openContextMenu(event, '${chat.id}')">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                `;
                item.onclick = (e) => {
                    if(!e.target.closest('.chat-options-btn')) loadChat(chat.id);
                };
                list.appendChild(item);
            });

            folderDiv.appendChild(header);
            folderDiv.appendChild(list);
            container.appendChild(folderDiv);
        });
    }

    function createCustomFolder() {
        const name = prompt("Enter Folder Name:");
        if(name && !appState.folders.includes(name)) {
            appState.folders.push(name);
            saveState();
        }
    }

    // --- CHAT LOGIC ---
    function createNewChat() {
        currentChatId = null;
        document.getElementById('chat-container').innerHTML = `
            <div class="message ai-msg">
                <div class="message-content"><strong>New Session.</strong><br>Ask a doubt (Maths, Physics, Chem). I will auto-sort it.</div>
            </div>`;
        renderSidebar(); // clear active selection
    }

    function loadChat(id) {
        if (!appState.chats[id]) return;
        currentChatId = id;
        
        const container = document.getElementById('chat-container');
        container.innerHTML = '';

        appState.chats[id].messages.forEach(msg => {
            appendMessageUI(msg.role, msg.content, msg.hasAttachment);
        });

        renderSidebar();
    }

    // Auto-Sort Logic
    function detectFolder(text) {
        const lower = text.toLowerCase();
        if (lower.match(/(\$|integral|derivative|calculus|algebra|matrix|geometry|trigonometry|math)/)) return 'Maths';
        if (lower.match(/(force|velocity|gravity|current|voltage|optics|lens|mirror|physics|kinematics)/)) return 'Physics';
        if (lower.match(/(reaction|acid|base|organic|compound|element|chemistry|atom|mole)/)) return 'Chemistry';
        if (lower.match(/(poem|story|grammar|english)/)) return 'English';
        return 'General';
    }

    async function sendMessage() {
        const txtInput = document.getElementById('user-input');
        const text = txtInput.value.trim();
        const sendBtn = document.getElementById('send-btn');

        if (!text && currentAttachments.length === 0) return;

        // UI Lock
        txtInput.disabled = true;
        sendBtn.style.opacity = 0.5;

        // 1. Create Chat if new
        if (!currentChatId) {
            currentChatId = 'c_' + Date.now();
            const folderName = detectFolder(text);
            appState.chats[currentChatId] = {
                id: currentChatId,
                title: text.substring(0, 30) || "Image Query",
                folder: folderName,
                timestamp: Date.now(),
                messages: []
            };
        }

        // 2. Add User Message (Save ONLY TEXT to state)
        const hasAttachment = currentAttachments.length > 0;
        appState.chats[currentChatId].messages.push({
            role: 'user', 
            content: text, 
            hasAttachment: hasAttachment 
        });
        
        appendMessageUI('user', text, hasAttachment);
        saveState();

        // 3. Prepare AI Prompt
        let fullPrompt = SYSTEM_PROMPT + "\n\n";
        
        // Add minimal context (Last 4 messages)
        const hist = appState.chats[currentChatId].messages.slice(-5, -1);
        hist.forEach(m => fullPrompt += `${m.role === 'user' ? 'Student' : 'Tutor'}: ${m.content}\n`);
        
        // Add extracted PDF text
        const textFiles = currentAttachments.filter(a => a.type === 'text');
        if (textFiles.length > 0) {
            fullPrompt += "\n[CONTEXT FROM FILES]:\n" + textFiles.map(f => f.content).join("\n\n");
        }
        
        fullPrompt += `\nSTUDENT: ${text}`;

        // 4. Puter Arguments (Text + Images)
        let args = [fullPrompt];
        // Add images for THIS REQUEST ONLY (not saved to DB)
        currentAttachments.filter(a => a.type === 'image').forEach(img => args.push(img.content));
        args.push({ model: MODEL, stream: true });

        // Reset Input
        txtInput.value = '';
        currentAttachments = [];
        document.getElementById('file-preview').innerHTML = '';
        autoResize(txtInput);

        // 5. Call AI
        let responseText = "";
        const aiDiv = createAiLoadingBubble();

        try {
            const response = await puter.ai.chat(...args);
            
            for await (const part of response) {
                if (part?.text) {
                    responseText += part.text;
                    aiDiv.innerHTML = marked.parse(responseText);
                    document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
                }
            }
            
            // Finalize
            aiDiv.innerHTML = marked.parse(responseText);
            MathJax.typesetPromise([aiDiv]);
            
            // Save AI Response
            appState.chats[currentChatId].messages.push({ role: 'ai', content: responseText });
            appState.chats[currentChatId].timestamp = Date.now();
            saveState();

        } catch (err) {
            aiDiv.innerHTML = `<span style="color:#ff6b6b">Error: ${err.message}</span>`;
        } finally {
            txtInput.disabled = false;
            sendBtn.style.opacity = 1;
            txtInput.focus();
        }
    }

    // --- UI HELPERS ---
    function appendMessageUI(role, text, hasAttachment) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ${role}-msg`;
        
        let html = '';
        if (hasAttachment && role === 'user') {
            html += `<div style="font-size:0.8rem; color:#888; font-style:italic; margin-bottom:5px;">
                <i class="fas fa-paperclip"></i> [Attachment Processed]
            </div>`;
        }
        
        html += marked.parse(text || "");
        div.innerHTML = `<div class="message-content">${html}</div>`;
        container.appendChild(div);
        MathJax.typesetPromise([div]);
        container.scrollTop = container.scrollHeight;
    }

    function createAiLoadingBubble() {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ai-msg`;
        div.innerHTML = `<div class="message-content"><i class="fas fa-spinner fa-spin"></i> Thinking...</div>`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return div.querySelector('.message-content');
    }

    // --- CONTEXT MENU LOGIC (Rename/Delete/Move) ---
    function openContextMenu(e, chatId) {
        e.stopPropagation();
        e.preventDefault();
        activeContextMenuChatId = chatId;
        
        const menu = document.getElementById('context-menu');
        const moveDiv = document.getElementById('move-options');
        
        // Populate Folders for "Move To"
        moveDiv.innerHTML = '';
        appState.folders.forEach(f => {
            if(f !== appState.chats[chatId].folder) {
                const btn = document.createElement('button');
                btn.className = 'ctx-item';
                btn.innerText = `Move to ${f}`;
                btn.onclick = () => moveChat(f);
                moveDiv.appendChild(btn);
            }
        });

        // Position
        menu.style.display = 'block';
        menu.style.left = `${e.clientX}px`;
        menu.style.top = `${e.clientY}px`;
    }

    function moveChat(targetFolder) {
        if(activeContextMenuChatId) {
            appState.chats[activeContextMenuChatId].folder = targetFolder;
            saveState();
        }
        closeCtx();
    }

    function triggerRename() {
        const newTitle = prompt("Rename Chat:");
        if(newTitle && activeContextMenuChatId) {
            appState.chats[activeContextMenuChatId].title = newTitle;
            saveState();
        }
        closeCtx();
    }

    function triggerDelete() {
        if(confirm("Delete this chat permanently?")) {
            delete appState.chats[activeContextMenuChatId];
            if(currentChatId === activeContextMenuChatId) createNewChat();
            saveState();
        }
        closeCtx();
    }

    function closeCtx() { document.getElementById('context-menu').style.display = 'none'; }
    document.addEventListener('click', closeCtx);

    // --- FILE HANDLING ---
    const fileInput = document.getElementById('file-input');
    const previewArea = document.getElementById('file-preview');
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    fileInput.addEventListener('change', async (e) => {
        for (const file of e.target.files) {
            const div = document.createElement('div');
            div.className = 'file-tag';
            div.innerText = 'â³ ' + file.name;
            previewArea.appendChild(div);
            
            try {
                let content = null; 
                let type = 'text';

                if(file.type.startsWith('image/')) {
                    type = 'image';
                    content = await toBase64(file);
                } else if(file.type === 'application/pdf') {
                    content = await extractPdfText(file);
                }

                currentAttachments.push({ type, content, name: file.name });
                div.innerText = (type === 'image' ? 'ðŸ–¼ï¸ ' : 'ðŸ“„ ') + file.name;
            } catch(err) {
                div.style.color = 'red';
                div.innerText = 'âŒ Error';
            }
        }
        fileInput.value = '';
    });

    // Utilities
    const toBase64 = file => new Promise((res, rej) => {
        const r = new FileReader();
        r.readAsDataURL(file);
        r.onload = () => res(r.result);
        r.onerror = rej;
    });

    async function extractPdfText(file) {
        const ab = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(ab).promise;
        let txt = "";
        for(let i=1; i<=Math.min(pdf.numPages, 10); i++) {
            const p = await pdf.getPage(i);
            const t = await p.getTextContent();
            txt += t.items.map(s=>s.str).join(" ") + "\n";
        }
        return txt;
    }

    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }

    // Init
    loadState();
    renderSidebar();

</script>
</body>
</html>
