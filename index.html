<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE/Boards AI Workspace</title>
    
    <!-- Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
    <!-- Markdown & MathJax -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #0d1117;
            --bg-sidebar: #010409;
            --border: #30363d;
            --accent: #2f81f7;
            --text-main: #c9d1d9;
            --text-dim: #8b949e;
            --user-msg: #1f6feb;
            --ai-msg: #161b22;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 260px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px;
            background: var(--border);
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }
        .new-chat-btn:hover { background: var(--accent); border-color: var(--accent); }

        #history-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .history-item {
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-dim);
            position: relative;
            padding-right: 30px; /* Space for delete icon */
        }
        
        .history-item:hover { background-color: #21262d; color: white; }
        .history-item.active { background-color: #21262d; color: white; border-left: 3px solid var(--accent); }

        .delete-chat {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            opacity: 0;
            padding: 5px;
        }
        .history-item:hover .delete-chat { opacity: 1; }

        /* --- MAIN CONTENT --- */
        #main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
        }

        header {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-dark);
        }

        .mobile-menu-btn { display: none; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 800px;
            margin: 0 auto 20px auto;
            animation: fadeIn 0.3s ease;
        }
        
        .message-content {
            padding: 12px 18px;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 1rem;
            position: relative;
            word-wrap: break-word;
        }

        .user-message { text-align: right; }
        .user-message .message-content {
            background-color: var(--user-msg);
            color: white;
            display: inline-block;
            text-align: left;
        }

        .ai-message .message-content {
            background-color: var(--ai-msg);
            border: 1px solid var(--border);
        }

        /* Markdown Styles */
        .ai-message pre { background: black; padding: 10px; border-radius: 5px; overflow-x: auto; margin: 10px 0; border: 1px solid #333; }
        .ai-message code { font-family: 'Consolas', monospace; color: #ff7b72; }
        .ai-message p { margin-bottom: 10px; }
        
        mjx-container { font-size: 1.1em !important; }

        /* --- INPUT AREA --- */
        #input-area {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-wrapper {
            width: 100%;
            max-width: 800px;
            position: relative;
        }

        .preview-area { display: flex; gap: 10px; margin-bottom: 8px; flex-wrap: wrap; }
        .file-chip { background: #21262d; border: 1px solid var(--border); padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px; }

        .input-box {
            display: flex;
            background: #161b22;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            align-items: flex-end;
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            resize: none;
            height: 24px;
            max-height: 150px;
            padding: 8px;
            outline: none;
        }

        .attach-btn, .send-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            padding: 8px;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .send-btn { color: var(--accent); }
        .send-btn:disabled { color: var(--border); }
        .attach-btn:hover { color: white; }

        input[type="file"] { display: none; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #sidebar {
                position: absolute;
                height: 100%;
                transform: translateX(-100%);
            }
            #sidebar.open { transform: translateX(0); }
            .mobile-menu-btn { display: block; }
        }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<aside id="sidebar">
    <div class="sidebar-header">
        <button class="new-chat-btn" onclick="startNewChat()">
            <i class="fas fa-plus"></i> New Doubt
        </button>
    </div>
    <div id="history-list">
        <!-- History items go here -->
    </div>
</aside>

<!-- MAIN APP -->
<div id="main-area">
    <header>
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <h1 style="font-size:1rem;">JEE/BOARDS <span style="color:var(--accent); font-weight:300;">WORKSPACE</span></h1>
        <span style="font-size:0.8rem; color:var(--text-dim);">Gemini 3 Pro</span>
    </header>

    <div id="chat-container">
        <!-- Welcome Message -->
        <div class="message ai-message">
            <div class="message-content">
                Hello! I am your <strong>JEE Advanced & Boards Tutor</strong>.<br>
                I have access to memory now. Start a new chat for a new topic, or select an old one from the sidebar to continue.
                <br><br>
                <strong>Subjects:</strong> PCM, English, PE.<br>
                <strong>Upload:</strong> Images or PDFs of questions.
            </div>
        </div>
    </div>

    <div id="input-area">
        <div class="input-wrapper">
            <div class="preview-area" id="preview-area"></div>
            <div class="input-box">
                <button class="attach-btn" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="file-input" multiple accept="image/*,.pdf">
                
                <textarea id="user-input" placeholder="Type your doubt here..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                
                <button class="send-btn" id="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const MODEL_NAME = 'gemini-3-pro-preview';
    const STORAGE_KEY = 'jee_tutor_chats_v1';
    
    // Strict System Prompt
    const SYSTEM_PROMPT = `You are a strict academic tutor for JEE Advanced and Class 12 Boards.
    1. SUBJECTS: Physics, Chemistry, Maths, English, Physical Education, Career Counselling.
    2. REFUSE: If asked about politics, celebrities, or coding (unless CS related), politely refuse.
    3. MATH FORMAT: You MUST use LaTeX. Inline: $ x^2 $, Block: $$ \int x dx $$.
    4. TONE: Serious, encouraging, concise.
    5. MEMORY: Use the provided context to answer follow-up questions.`;

    // --- STATE ---
    let sessions = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let currentSessionId = null; 
    let currentAttachments = []; // {type, content, name}

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        renderSidebar();
        // If no sessions, start new. If sessions exist, don't load one automatically to show welcome screen, 
        // OR load the most recent one. Let's show welcome screen (currentSessionId = null).
    });

    // --- SIDEBAR & SESSION LOGIC ---
    function renderSidebar() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        
        // Sort by newest first
        const sorted = [...sessions].sort((a, b) => b.timestamp - a.timestamp);

        sorted.forEach(session => {
            const div = document.createElement('div');
            div.className = `history-item ${session.id === currentSessionId ? 'active' : ''}`;
            div.onclick = (e) => loadSession(session.id);
            div.innerHTML = `
                <i class="far fa-comment-alt"></i> &nbsp; ${session.title}
                <button class="delete-chat" onclick="deleteSession(event, '${session.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            list.appendChild(div);
        });
    }

    function startNewChat() {
        currentSessionId = null;
        document.getElementById('chat-container').innerHTML = `
             <div class="message ai-message">
                <div class="message-content">
                    <strong>New Session Started.</strong><br>What topic are we studying now?
                </div>
            </div>`;
        renderSidebar();
        closeSidebarOnMobile();
    }

    function loadSession(id) {
        const session = sessions.find(s => s.id === id);
        if (!session) return;

        currentSessionId = id;
        const container = document.getElementById('chat-container');
        container.innerHTML = ''; // Clear current view

        // Re-render messages
        session.messages.forEach(msg => {
            appendMessageToUI(msg.role, msg.content, msg.attachments, false);
        });

        renderSidebar(); // Update active class
        closeSidebarOnMobile();
    }

    function deleteSession(e, id) {
        e.stopPropagation(); // Prevent loading the chat when clicking delete
        if(confirm('Delete this chat history?')) {
            sessions = sessions.filter(s => s.id !== id);
            saveToStorage();
            if (currentSessionId === id) startNewChat();
            renderSidebar();
        }
    }

    function saveToStorage() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
    }

    // --- FILE HANDLING ---
    const fileInput = document.getElementById('file-input');
    
    // PDF Worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        for (const file of files) {
            await processFile(file);
        }
        fileInput.value = ''; // reset
    });

    async function processFile(file) {
        const previewDiv = document.getElementById('preview-area');
        const id = Date.now();
        
        previewDiv.innerHTML += `<div class="file-chip" id="file-${id}">‚è≥ ${file.name}</div>`;

        try {
            let data = null;
            let type = 'text'; // Default for PDF extracted text

            if (file.type.startsWith('image/')) {
                type = 'image';
                data = await toBase64(file);
            } else if (file.type === 'application/pdf') {
                data = await extractPdfText(file);
            }

            // Update UI
            document.getElementById(`file-${id}`).innerHTML = `
                ${type === 'image' ? 'üñºÔ∏è' : 'üìÑ'} ${file.name} 
                <span style="cursor:pointer;color:#ff6b6b;margin-left:5px;" onclick="removeAttachment('${id}')">√ó</span>
            `;
            
            // Store in temp memory
            currentAttachments.push({ id, type, content: data, name: file.name });

        } catch (err) {
            console.error(err);
            document.getElementById(`file-${id}`).innerHTML = `‚ùå Error`;
        }
    }

    function removeAttachment(id) {
        currentAttachments = currentAttachments.filter(a => a.id != id);
        document.getElementById(`file-${id}`).remove();
    }

    // --- CHAT LOGIC ---
    async function sendMessage() {
        const textarea = document.getElementById('user-input');
        const text = textarea.value.trim();
        const sendBtn = document.getElementById('send-btn');

        if (!text && currentAttachments.length === 0) return;

        // 1. Create Session if not exists
        if (!currentSessionId) {
            currentSessionId = 'chat_' + Date.now();
            sessions.push({
                id: currentSessionId,
                title: text.substring(0, 30) || "Image/PDF Query",
                timestamp: Date.now(),
                messages: []
            });
        }

        // 2. Lock UI
        textarea.disabled = true;
        sendBtn.disabled = true;

        // 3. Update UI & Save User Message
        const userMsgObj = {
            role: 'user',
            content: text,
            attachments: [...currentAttachments] // Copy current array
        };
        appendMessageToUI('user', text, currentAttachments);
        
        // Save to session memory
        const currentSession = sessions.find(s => s.id === currentSessionId);
        currentSession.messages.push(userMsgObj);
        currentSession.timestamp = Date.now(); // Update time
        saveToStorage();
        renderSidebar(); // Update list order

        // 4. Construct Prompt (Context + New Msg)
        // We recreate the prompt using the last 6 messages for context to save tokens
        let historyContext = "";
        const recentMsgs = currentSession.messages.slice(-6); 
        
        recentMsgs.forEach(m => {
             if(m.role === 'user') {
                 // Include PDF text in context if it was an attachment
                 const pdfs = m.attachments.filter(a => a.type === 'text');
                 let attachText = pdfs.map(p => `[PDF Content: ${p.name}]\n${p.content}`).join('\n');
                 historyContext += `Student: ${attachText}\n${m.content}\n`;
             } else {
                 historyContext += `Tutor: ${m.content}\n`;
             }
        });

        const fullPrompt = `${SYSTEM_PROMPT}\n\nPREVIOUS CONTEXT:\n${historyContext}\n\nCURRENT QUESTION: ${text}`;

        // 5. Prepare Puter Args
        // Handle images (Gemini accepts text + image URLs/Base64)
        const currentImages = currentAttachments.filter(a => a.type === 'image');
        let args = [fullPrompt];
        currentImages.forEach(img => args.push(img.content));
        args.push({ model: MODEL_NAME, stream: true });

        // Clear Inputs
        textarea.value = '';
        currentAttachments = [];
        document.getElementById('preview-area').innerHTML = '';
        autoResize(textarea);

        // 6. Call AI
        let aiResponseText = "";
        const aiBubble = createAiBubble();
        
        try {
            const response = await puter.ai.chat(...args);
            
            for await (const part of response) {
                if(part?.text) {
                    aiResponseText += part.text;
                    aiBubble.innerHTML = marked.parse(aiResponseText);
                    // Smooth scroll
                    document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
                }
            }
            
            // Final render with MathJax
            aiBubble.innerHTML = marked.parse(aiResponseText);
            MathJax.typesetPromise([aiBubble]);

            // Save AI Message
            currentSession.messages.push({
                role: 'ai',
                content: aiResponseText,
                attachments: []
            });
            saveToStorage();

        } catch (err) {
            aiBubble.innerHTML = `Error: ${err.message}`;
        } finally {
            textarea.disabled = false;
            sendBtn.disabled = false;
            textarea.focus();
        }
    }

    // --- UI HELPERS ---
    function appendMessageToUI(role, text, attachments = [], animate = true) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ${role}-message`;
        
        let contentHtml = '';

        // Render Attachments
        if (attachments && attachments.length > 0) {
            const imgs = attachments.filter(a => a.type === 'image');
            const pdfs = attachments.filter(a => a.type === 'text');
            
            if (imgs.length) {
                contentHtml += `<div style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:5px;">`;
                imgs.forEach(img => {
                    contentHtml += `<img src="${img.content}" style="height:100px; border-radius:5px; border:1px solid #333;">`;
                });
                contentHtml += `</div>`;
            }
            if (pdfs.length) {
                pdfs.forEach(pdf => {
                    contentHtml += `<div style="font-size:0.8rem; color:#888; margin-bottom:5px;">üìÑ Attached: ${pdf.name}</div>`;
                });
            }
        }

        const safeText = text ? marked.parse(text) : '';
        contentHtml += safeText;

        div.innerHTML = `<div class="message-content">${contentHtml}</div>`;
        container.appendChild(div);
        
        if (!animate) div.style.animation = 'none';
        
        MathJax.typesetPromise([div]);
        container.scrollTop = container.scrollHeight;
    }

    function createAiBubble() {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = `message ai-message`;
        div.innerHTML = `<div class="message-content"><i class="fas fa-circle-notch fa-spin"></i> Thinking...</div>`;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return div.querySelector('.message-content');
    }

    // --- UTILS ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }
    
    function closeSidebarOnMobile() {
        if(window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('open');
        }
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    function handleEnter(e) {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    async function extractPdfText(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let text = "";
        const max = Math.min(pdf.numPages, 10); // Limit 10 pages for simplicity
        for(let i=1; i<=max; i++){
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(s => s.str).join(" ") + "\n";
        }
        return text;
    }
</script>

</body>
</html>
